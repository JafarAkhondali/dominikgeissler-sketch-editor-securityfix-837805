<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <script>
    // Load all programs in the /examples folder and add them as selectable options
    // into the select-dropdown
    document.addEventListener("DOMContentLoaded", () => {
      const addOptions = (files) => {
        const select = document.getElementById("example-select");
        files.forEach((f) => {
          const option = document.createElement("option");
          option.value = f;
          option.text = f;
          select.appendChild(option);
        });
      }

      // Get all examples in the /examples folder
      fetch("/examples")
        .then((res) => res.json())
        .then((data) => addOptions(data))
        .catch((err) => console.error("Error: ", err))
    });
  </script>
  <title>Sketch Editor</title>
</head>

<body>
  <header>
    Sketch Editor
  </header>
  <div id="editor">
    <div id="button-container">
      <button id="run">Run</button>
      <button id="example" disabled>Load Example</button>
      <select id="example-select">
        <option value="" disabled selected>Select an example to load...</option>
      </select>
    </div>
    <textarea id="code" placeholder="Your code goes here..."></textarea>
    <div id="output" hidden></div>
  </div>

  <script>
    // Sets visual loading by disabling buttons and setting the cursor
    const setLoading = () => {
      // Add the loading class to display progress cursor
      document.body.classList.add("loading");
      document.getElementById("code").classList.add("loading");

      // Disable the buttons
      document.getElementById("run").disabled = true;
      document.getElementById("example").disabled = true;
      document.getElementById("example-select").disabled = true;
    }

    // Unsets the visual loading
    const unsetLoading = () => {
      // Remove loading class
      document.body.classList.remove("loading");
      document.getElementById("code").classList.remove("loading");

      // Enable the buttons
      document.getElementById("run").disabled = false;
      document.getElementById("example").disabled = false;
      document.getElementById("example-select").disabled = false;
    }

    // Correctly renders console output with colors that are encoded by ANSI codes
    const renderText = (txt) => {
      let ansiRegex = /\[\d+;\d+m/g;

      // First, replace the \n by br tags
      let htmlText = txt.replace(/\n/g, "<br>")

      htmlText = txt.replace(ansiRegex, m => {
        // Retrieve the code and split it to obtain style and color
        let colorCode = m.slice(1, -1);
        let [style, color] = colorCode.split(";");

        let cssClass = "";

        // Color code <-> class
        switch (color) {
          case "31":
            cssClass = "red";
            break;
          case "32":
            cssClass = "green";
            break;
          default:
            break;
        }

        return `<span class="${cssClass}">`;
      });

      // Close span tags
      return htmlText.replace(/\[0m/g, '</span>')
    }

    const code = document.getElementById("code");

    // Some UX improvements for using the "code editor"
    code.addEventListener("keydown", (e) => {
      if (e.key === "Tab") {
        e.preventDefault()

        // Insert a \t character
        const start = code.selectionStart;
        const end = code.selectionEnd;
        const value = code.value;
        code.value = value.substring(0, start) + '\t' + value.substring(end);
        code.selectionStart = code.selectionEnd = start + 1;
      }
      // When '{' is inserted, automatically insert a '}' as well and move the cursor
      else if (e.key === "{") {
        e.preventDefault()

        const start = code.selectionStart;
        const end = code.selectionEnd;
        const value = code.value;
        code.value = value.substring(0, start) + '{' + '}' + value.substring(end);
        code.selectionStart = code.selectionEnd = start + 1;
      }
      // When '(' is inserted, automatically insert a ')' as well and move the cursor
      else if (e.key === "(") {
        e.preventDefault()

        const start = code.selectionStart;
        const end = code.selectionEnd;
        const value = code.value;
        code.value = value.substring(0, start) + '(' + ')' + value.substring(end);
        code.selectionStart = code.selectionEnd = start + 1;
      }
      // When '[' is inserted, automatically insert a ']' as well and move the cursor
      else if (e.key === "[") {
        e.preventDefault()

        const start = code.selectionStart;
        const end = code.selectionEnd;
        const value = code.value;
        code.value = value.substring(0, start) + '[' + ']' + value.substring(end);
        code.selectionStart = code.selectionEnd = start + 1;
      }
      // If backspace is pressed if the cursor is in between two brackets, remove both
      else if (e.key === "Backspace") {
        const start = code.selectionStart;
        const end = code.selectionEnd;
        const value = code.value;

        if (value[start - 1] === "{" && value[end] === "}") {
          e.preventDefault();
          code.value = value.substring(0, start - 1) + value.substring(end + 1);
          code.selectionStart = code.selectionEnd = start - 1;
        } else if (value[start - 1] === "(" && value[end] === ")") {
          e.preventDefault();
          code.value = value.substring(0, start - 1) + value.substring(end + 1);
          code.selectionStart = code.selectionEnd = start - 1;
        } else if (value[start - 1] === "[" && value[end] === "]") {
          e.preventDefault();
          code.value = value.substring(0, start - 1) + value.substring(end + 1);
          code.selectionStart = code.selectionEnd = start - 1;
        }
      }
    });

    // ## Select ##
    // Disable the button if no example is selected
    document.getElementById("example-select").addEventListener("change", (e) => {
      document.getElementById("example").disabled = e.target.value === "";
    });

    // ###########
    // # Buttons #
    // ###########

    // Run the program
    document.getElementById("run").addEventListener("click", async (e) => {
      let codeContent = document.getElementById("code").value

      document.getElementById("output").innerHTML = "";

      // Set the visual loading
      setLoading();

      // Send the program to the server to execute it
      // Afterwards display the result message
      await fetch("/", {
        method: "POST",
        body: `code=${encodeURIComponent(codeContent)}`,
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        }
      }).then(res => res.text())
        .then(data => document.getElementById("output").innerHTML = `<pre>${renderText(data)}`)
        .catch(err => console.error("Error: ", err))
      unsetLoading();
      document.getElementById("output").hidden = false;
    });

    // Load an example
    document.getElementById("example").addEventListener("click", (e) => {
      const exampleSelect = document.getElementById("example-select");
      const code = document.getElementById("code");
      let file = exampleSelect.value;
      if (!!file) {
        // Reset selected example
        exampleSelect.value = "";

        // Set the visual loading
        setLoading();

        // Get the selected examples' code from the server
        fetch("/load-example", {
          method: "POST",
          body: `selectedFile=${encodeURIComponent(file)}`,
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          }
        }).then((res) => res.text())
          .then((data) => {
            code.value = data;
          })
          .catch((err) => console.error("Error:", err))
        // Unset the visual loading
        unsetLoading();

        // Disable the button again
        document.getElementById("example").disabled = true;
      }
    });
  </script>
</body>

</html>